import socket
import threading
import urllib.request
import sys
import argparse
import time

# -----------------------
# --- ARGUMENTS CLI ---
# -----------------------
parser = argparse.ArgumentParser(description="HTTP Proxy Relay")
parser.add_argument("--http-port", type=int, default=8080, help="Local HTTP listening port")
parser.add_argument("--relay-host", type=str, required=True, help="HTTP relay host")
parser.add_argument("--relay-port", type=int, default=80, help="HTTP relay port")
parser.add_argument("--debug-transit", action="store_true", help="Debug relay traffic")
args = parser.parse_args()

LOCAL_PORT = args.http_port
RELAY_HOST = args.relay_host
RELAY_PORT = args.relay_port
DEBUG = args.debug_transit

# -----------------------
# --- SYSTEM PROXY ---
# -----------------------
def get_system_proxy():
    try:
        proxy = urllib.request.getproxies().get('http')
        if proxy:
            if proxy.startswith('http://'):
                proxy = proxy[7:]
            host, port = proxy.split(':')
            return host, int(port)
    except:
        pass
    return None, None

SYS_PROXY_HOST, SYS_PROXY_PORT = get_system_proxy()
if SYS_PROXY_HOST:
    print(f"System proxy detected: {SYS_PROXY_HOST}:{SYS_PROXY_PORT}")
else:
    print("No system proxy detected")

# -----------------------
# --- TEST RELAY ---
# -----------------------
def test_relay():
    print(f"Testing relay {RELAY_HOST}:{RELAY_PORT} ...")
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        target_host = SYS_PROXY_HOST or RELAY_HOST
        target_port = SYS_PROXY_PORT or RELAY_PORT
        sock.settimeout(5)
        sock.connect((target_host, target_port))
        connect_req = f"CONNECT ifconfig.me:443 HTTP/1.1\r\nHost: ifconfig.me:443\r\nConnection: close\r\n\r\n"
        sock.sendall(connect_req.encode())
        resp = sock.recv(4096).decode()
        sock.close()
        if "200" in resp:
            print("✅ Proxy relay reachable")
            return True
        else:
            print("❌ Proxy relay CONNECT failed")
            return False
    except Exception as e:
        print("❌ Proxy relay test error:", e)
        return False

if not test_relay():
    print("Aborting: proxy relay not reachable")
    sys.exit(1)

# -----------------------
# --- RELAY THREAD ---
# -----------------------
def handle_client(client_sock, client_addr):
    try:
        # connect to relay
        server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        target_host = SYS_PROXY_HOST or RELAY_HOST
        target_port = SYS_PROXY_PORT or RELAY_PORT
        server_sock.connect((target_host, target_port))
        print(f"[{client_addr}] Connected to relay {target_host}:{target_port}")

        def relay(src, dst, direction):
            while True:
                try:
                    data = src.recv(8192)
                    if not data:
                        break
                    dst.sendall(data)
                    if DEBUG:
                        print(f"[{client_addr}] {direction}: {len(data)} bytes")
                except:
                    break

        t1 = threading.Thread(target=relay, args=(client_sock, server_sock, "Client→Relay"))
        t2 = threading.Thread(target=relay, args=(server_sock, client_sock, "Relay→Client"))
        t1.start()
        t2.start()
        t1.join()
        t2.join()

        client_sock.close()
        server_sock.close()
    except Exception as e:
        print(f"[{client_addr}] Relay error:", e)
        client_sock.close()
        if 'server_sock' in locals():
            server_sock.close()

# -----------------------
# --- LISTENER ---
# -----------------------
listener = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
listener.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
listener.bind(('', LOCAL_PORT))
listener.listen(50)
print(f"Local HTTP relay listening on {LOCAL_PORT}")

while True:
    try:
        client, addr = listener.accept()
        print(f"New client: {addr}")
        t = threading.Thread(target=handle_client, args=(client, addr))
        t.start()
    except KeyboardInterrupt:
        print("Shutting down...")
        listener.close()
        break